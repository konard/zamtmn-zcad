# Case Study: Issue #679 - Иконки не подгружаются в панель инструментов электронных таблиц

## Краткое описание проблемы
После реализации PR #680, который заменил текстовые кнопки на иконки в `uzvspreadsheet_gui.pas`, 
обнаружилась проблема: картинки не подгрузились. Требуется изучить причину 
(не находит картинку, большой размер картинки и её не видно, нужно подгонять размер).

## Временная линия событий

### 2025-12-10 (Дата создания issue #679)
- **Событие**: Создан issue #679 с требованием заменить текстовые кнопки на иконки
- **Требования**:
  - Создать картинка - new.png
  - Открыть картинка - open.png
  - Сохранить картинка - saveas.png
  - Назад картинка - undo.png
  - Вперед картинка - redo.png
  - Расчёт картинка - spreadsheet_calc.png
  - Автопересчёт картинка - spreadsheet_autocalc.png

### 2025-12-10 20:07:25 (Мерж PR #680)
- **Событие**: PR #680 был смержен в мастер
- **Изменения**:
  - Добавлена зависимость от `uzcimagesmanager`
  - `ShowCaptions := False` - отключен текст на кнопках
  - `Images := ImagesManager.IconList` - подключен список иконок
  - Ширина кнопок уменьшена с 80 до 28 пикселей
  - Назначены ImageIndex для всех кнопок через `ImagesManager.GetImageIndex()`

### 2025-12-10 22:50:02 (Коммит c9b28003)
- **Событие**: veb86 добавил картинки в репозиторий
- **Файлы**:
  - `environment/runtimefiles/AllCPU-AllOS/common/data/images/actions/velec/spreadsheet_autocalc.png`
  - `environment/runtimefiles/AllCPU-AllOS/common/data/images/actions/velec/spreadsheet_calc.png`
  - SVG файлы в `cad_source/images/velec/`

### 2025-12-11 08:01:49 (Комментарий к issue #679)
- **Событие**: veb86 сообщил, что картинки не подгрузились
- **Требования**:
  - Изучить причину (не находит картинку, большой размер и её не видно)
  - Посмотреть как в проекте выполнена подгрузка меню в toolbar-ы
  - Создать case study анализ проблемы

## Техническое исследование

### Анализ ImagesManager

**Файл**: `cad_source/zcad/gui/uzcimagesmanager.pas`

**Как работает**:
1. ImagesManager сканирует директорию с изображениями при инициализации
2. Создаёт TImageList с поддержкой разных разрешений: [16, 24, 32, 48, 64]
3. При запросе изображения через GetImageIndex() загружает PNG и добавляет в ImageList
4. Использует ленивую загрузку: изображения загружаются только при первом обращении

**Инициализация** (из `uzcmainform.pas`):
```pascal
ImagesManager.ScanDir(ConcatPaths([expandpath('$(DistribPath)'),CFSimagesDir]));
ImagesManager.LoadAliasesDir(
  ConcatPaths([expandpath('$(DistribPath)'),CFSimagesDir,CFSnavigatorimaFile]));
```

### Обнаруженные проблемы

#### Проблема #1: Размер изображений

**Обнаружение**:
```bash
$ file spreadsheet_*.png
spreadsheet_autocalc.png: PNG image data, 256 x 256, 8-bit/color RGBA, non-interlaced
spreadsheet_calc.png:     PNG image data, 256 x 256, 8-bit/color RGBA, non-interlaced

$ file {new,open,saveas,undo,redo}.png
new.png:    PNG image data, 16 x 16, 8-bit/color RGBA, non-interlaced
open.png:   PNG image data, 16 x 16, 8-bit/color RGBA, non-interlaced
saveas.png: PNG image data, 16 x 16, 8-bit/color RGBA, non-interlaced
undo.png:   PNG image data, 16 x 16, 8-bit/color RGBA, non-interlaced
redo.png:   PNG image data, 16 x 16, 8-bit/color RGBA, non-interlaced
```

**Вывод**: Иконки spreadsheet_calc и spreadsheet_autocalc имеют размер 256x256 пикселей, 
в то время как все остальные иконки toolbar-а имеют размер 16x16 пикселей.

**Последствия**:
- При размере кнопки 28x28 пикселей, изображение 256x256 будет масштабироваться
- Возможны проблемы с отображением или производительностью
- Несоответствие стилю остальных иконок

#### Проблема #2: Путь к изображениям

**Текущий код**:
```pascal
FBtnCalc.ImageIndex := ImagesManager.GetImageIndex('velec/spreadsheet_calc');
FBtnAutoCalc.ImageIndex := ImagesManager.GetImageIndex('velec/spreadsheet_autocalc');
```

**Расположение файлов**:
```
environment/runtimefiles/AllCPU-AllOS/common/data/images/actions/velec/spreadsheet_calc.png
environment/runtimefiles/AllCPU-AllOS/common/data/images/actions/velec/spreadsheet_autocalc.png
```

**Анализ**:
- ImagesManager.ScanDir() сканирует директорию `images/actions/`
- GetImageIndex() ищет файлы по имени (без расширения) с учётом подпапок
- Путь `velec/spreadsheet_calc` должен работать корректно

#### Проблема #3: Регистрация разрешений в TImageList

**Из кода ImagesManager**:
```pascal
FIconList.RegisterResolutions([16,24,32,48,64]);
```

TImageList зарегистрирован для работы с разрешениями 16, 24, 32, 48, 64 пикселей.
Изображения 256x256 не входят в этот диапазон и могут некорректно обрабатываться.

## Корневые причины проблемы

### Основная причина
**Несоответствие размера изображений требованиям TImageList**

Изображения spreadsheet_calc.png и spreadsheet_autocalc.png имеют размер 256x256 пикселей,
что значительно превышает ожидаемые размеры для toolbar иконок (16-64 пикселей).

### Сопутствующие факторы
1. Отсутствие валидации размера изображений при загрузке
2. Возможно, изображения не были подготовлены в нужных размерах
3. В репозитории присутствуют SVG версии иконок, но код не использует их

## Предлагаемые решения

### Решение #1: Изменить размер PNG файлов (Рекомендуется)

**Действия**:
1. Создать версии изображений размером 16x16 пикселей для основного использования
2. Опционально создать версии 24x24, 32x32 для поддержки разных DPI
3. Заменить существующие файлы или сохранить их как `*_16.png`, `*_24.png` и т.д.

**Преимущества**:
- Минимальные изменения кода
- Соответствие стандартам проекта
- Оптимальная производительность

**Недостатки**:
- Требуется обработка изображений

### Решение #2: Использовать SVG файлы

**Действия**:
1. Конвертировать SVG файлы в PNG нужных размеров при сборке
2. Или добавить поддержку SVG в ImagesManager

**Преимущества**:
- Векторная графика масштабируется без потерь
- Один файл для всех разрешений

**Недостатки**:
- Требует значительных изменений в ImagesManager
- Зависимость от библиотеки для работы с SVG

### Решение #3: Динамическое масштабирование

**Действия**:
1. Изменить ImagesManager.loadicon() для автоматического масштабирования больших изображений
2. Добавить параметр желаемого размера в GetImageIndex()

**Преимущества**:
- Универсальное решение
- Работает с изображениями любого размера

**Недостатки**:
- Усложнение кода
- Возможная потеря качества при масштабировании

## Рекомендация

**Рекомендуется Решение #1**: Изменить размер PNG файлов до 16x16 пикселей.

Это наиболее простое и эффективное решение, которое:
- Соответствует существующей архитектуре
- Минимизирует изменения кода
- Обеспечивает единообразие с остальными иконками
- Оптимально для производительности

## Дополнительные исследования

### Онлайн ресурсы
- Документация Lazarus TImageList: https://wiki.freepascal.org/TImageList
- Рекомендации по размерам иконок для toolbar: стандарт 16x16 для обычного DPI
- Поддержка высокого DPI: рекомендуется предоставлять версии 16, 24, 32 пикселей

### Примеры из других проектов
- В большинстве проектов Lazarus/Delphi toolbar иконки имеют размер 16x16 или 24x24
- Visual Studio Code использует 16x16 для основных иконок
- GIMP использует 16x16 для toolbar и 48x48 для диалогов

## Выводы

Проблема с незагружающимися иконками вызвана несоответствием размера изображений 
(256x256) ожидаемому размеру toolbar иконок (16x16). TImageList в Lazarus 
оптимизирован для работы с небольшими иконками и может некорректно отображать 
или полностью игнорировать слишком большие изображения.

Для решения проблемы необходимо создать версии изображений spreadsheet_calc.png 
и spreadsheet_autocalc.png размером 16x16 пикселей, что приведёт их в соответствие 
с остальными иконками проекта.
