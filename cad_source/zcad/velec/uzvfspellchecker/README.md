# Модуль проверки орфографии uzvfspellchecker

## Техническое задание

### 1. Общее описание

Модуль предназначен для визуализации и управления орфографическими ошибками в текстовых элементах проекта ZCAD. Модуль использует библиотеку fphunspell (обертка над Hunspell) для поиска орфографических ошибок и предоставляет пользователю удобный интерфейс для их просмотра и исправления.

### 2. Архитектура модуля

Модуль состоит из трех основных слоев:

#### 2.1. Data (Данные)
- **uzvfspelldata.pas** - структуры данных для хранения информации об ошибках
  - TSpellError - запись, содержащая информацию об одной ошибке
  - TSpellErrorList - список ошибок
  - Поля TSpellError:
    - ErrorWord: string - слово с ошибкой
    - Sentence: string - предложение, в котором встретилась ошибка
    - Suggestions: TStringList - варианты исправления
    - Position: integer - позиция ошибки в тексте

#### 2.2. Logic (Логика)
- **uzvfspelllogic.pas** - бизнес-логика поиска и обработки ошибок
  - Функция поиска всех ошибок в тексте
  - Функция получения вариантов исправления
  - Функция извлечения предложения с ошибкой
  - Использует глобальный SpellChecker из uzcSpeller
  - Методы:
    - FindAllErrors(Text: string): TSpellErrorList
    - GetSuggestions(Word: string): TStringList
    - ExtractSentence(Text: string; Position: integer): string

#### 2.3. UI (Интерфейс)
- **uzvfspellform.pas** - модуль формы
- **uzvfspellform.lfm** - визуальное описание формы

### 3. Описание пользовательского интерфейса

#### 3.1. Компоненты формы

**Верхняя панель (TToolBar):**
- Кнопка "Обновить" - повторный поиск ошибок в текущем тексте
- Связь с TActionList для управления действиями

**Левая панель (TVirtualStringTree):**
- Отображает список всех найденных ошибок
- Колонки:
  - Слово с ошибкой
  - Количество вхождений
- Сортировка по умолчанию: по порядку появления в тексте
- При выборе элемента:
  - Обновляется правая панель с вариантами исправления
  - Обновляется нижняя панель с предложением

**Правая панель (TVirtualStringTree):**
- Отображает варианты исправления для выбранной ошибки
- Колонки:
  - Вариант исправления
- Пустая, если ошибка не выбрана
- Двойной клик по варианту может применить исправление

**Нижняя панель (TLabel):**
- Отображает предложение, в котором встретилась выбранная ошибка
- Ошибочное слово может быть выделено другим цветом
- Автоматический перенос текста (WordWrap = True)
- Выравнивание: alBottom

#### 3.2. Расположение компонентов

```
+--------------------------------------------------+
|  [TToolBar]                                       |
|  [Обновить]                                       |
+--------------------------------------------------+
|  TVirtualStringTree  |  TVirtualStringTree       |
|  (Ошибки)            |  (Варианты исправления)   |
|                      |                            |
|  - слово1            |  - вариант1                |
|  - слово2            |  - вариант2                |
|  - слово3            |  - вариант3                |
|                      |                            |
+--------------------------------------------------+
|  TLabel: "Предложение с выделенной ошибкой..."   |
+--------------------------------------------------+
```

### 4. Взаимодействие с существующим кодом

#### 4.1. Используемые компоненты
- **SpellChecker** (из uzcSpeller.pas) - глобальный объект проверки орфографии
- **TSpeller** (из uSpeller.pas) - класс для работы с Hunspell
- **Методы TSpeller:**
  - SpellTextSimple(Text: string; var Details: string; Opts: TSpellOpts): TSpellResult
  - SpellWord(Word: string): boolean
  - GetSuggestions(Word: string): TStringList (предполагаемый метод)

#### 4.2. Константы и типы
```pascal
// Результаты проверки
TSpeller.WrongLang  - неправильный язык/ошибка
TSpeller.MixedLang  - смешанные языки
TSpeller.NoText     - нет текста

// Опции проверки
TSpeller.CSpellOptFast    - быстрая проверка
TSpeller.CSpellOptDetail  - детальная проверка с подробностями
```

### 5. Требования к коду

#### 5.1. Стандарты оформления (согласно CLAUDE.md)
- Все комментарии на русском языке
- Максимальная длина функции: 30 строк
- Максимальная длина строки: 100 символов
- Максимальная вложенность: 3 уровня
- Отступы: 2 пробела
- Имена переменных: полные, осмысленные, на английском
- Константы: именованные, без магических чисел
- Каждый файл начинается с заголовка лицензии и автора

#### 5.2. Логирование
- Использовать: `uses uzclog;`
- Тип сообщения: только `LM_Info`
- Формат: `programlog.LogOutFormatStr('описание: значение = %d', [value], LM_Info);`

#### 5.3. Модульность
- Каждый модуль решает одну задачу
- Размер модуля: 300-500 строк
- Разделение на Data, Logic, UI
- Без смешения логики и интерфейса

### 6. Функциональные требования

#### 6.1. Обязательная функциональность
1. Поиск всех орфографических ошибок в переданном тексте
2. Отображение списка ошибок в левом дереве
3. Получение вариантов исправления от Hunspell
4. Отображение вариантов в правом дереве при выборе ошибки
5. Отображение предложения с ошибкой в нижней метке
6. Обновление списка ошибок по кнопке "Обновить"

#### 6.2. Дополнительная функциональность
1. Выделение ошибочного слова в предложении цветом
2. Счетчик вхождений для каждой ошибки
3. Возможность применения исправления (по двойному клику)
4. Фильтрация ошибок (все/только неизвестные слова)

### 7. Структура файлов

```
cad_source/zcad/velec/uzvfspellchecker/
├── README.md                    # Данный документ
├── uzvfspelldata.pas            # Структуры данных
├── uzvfspelllogic.pas           # Бизнес-логика
├── uzvfspellform.pas            # Код формы
└── uzvfspellform.lfm            # Визуальная часть формы
```

### 8. Зависимости

```pascal
uses
  // Стандартные модули
  Classes, SysUtils, Forms, Controls, Graphics, Dialogs,
  ComCtrls, ActnList, StdCtrls,

  // VirtualTreeView
  VirtualTrees,

  // ZCAD модули
  uzcSpeller,     // Глобальный SpellChecker
  uSpeller,       // Класс TSpeller
  uzcLog,         // Логирование

  // Модули проекта
  uzvfspelldata,  // Структуры данных
  uzvfspelllogic; // Бизнес-логика
```

### 9. Примеры использования

#### 9.1. Использование из другого модуля
```pascal
uses uzvfspellform;

// Показать форму проверки орфографии
procedure ShowSpellChecker(const TextToCheck: string);
var
  SpellForm: TSpellCheckerForm;
begin
  SpellForm := TSpellCheckerForm.Create(nil);
  try
    SpellForm.CheckText(TextToCheck);
    SpellForm.ShowModal;
  finally
    SpellForm.Free;
  end;
end;
```

#### 9.2. Обновление списка ошибок
```pascal
// В обработчике кнопки "Обновить"
procedure TSpellCheckerForm.RefreshErrors;
begin
  ClearErrorList;
  FindAndDisplayErrors(CurrentText);
end;
```

### 10. Возможности для улучшения

После базовой реализации модуль может быть улучшен следующим образом:

1. **Производительность:**
   - Кэширование результатов проверки
   - Асинхронная проверка больших текстов
   - Прогресс-бар для длительных операций

2. **Функциональность:**
   - Добавление слов в словарь пользователя
   - Игнорирование определенных слов
   - Экспорт списка ошибок
   - Статистика по ошибкам

3. **Удобство:**
   - Настройки отображения
   - Горячие клавиши
   - Контекстное меню
   - История исправлений

4. **Интеграция:**
   - Проверка всех текстов в чертеже
   - Автоматическая проверка при вводе
   - Интеграция с командой SpellCheck

### 11. Тестирование

#### 11.1. Тестовые случаи
1. Проверка текста без ошибок
2. Проверка текста с одной ошибкой
3. Проверка текста с множественными ошибками
4. Проверка пустого текста
5. Проверка текста с неизвестными словами
6. Обновление списка после изменения текста

#### 11.2. Граничные случаи
- Очень длинный текст (> 10000 символов)
- Текст со специальными символами
- Текст на смешанных языках
- Слова с цифрами и символами

### 12. Заключение

Данный модуль должен обеспечить удобный и понятный интерфейс для работы с орфографическими ошибками, следуя принципам модульности, читаемости и соответствуя стандартам проекта ZCAD.
